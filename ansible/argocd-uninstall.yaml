---
- name: Uninstall ArgoCD from Kubernetes Cluster
  hosts: controlplane[0]
  gather_facts: false
  vars:
    cluster_config: "{{ lookup('file', 'tmp/' ~ cluster_name ~ '/cluster_config.json') | from_json }}"
  pre_tasks:
    - name: Load ArgoCD defaults
      ansible.builtin.include_vars:
        file: argocd/defaults/main-argocd.yaml

  tasks:
    - name: List all ArgoCD Applications
      ansible.builtin.shell:
        cmd: kubectl get applications -n {{ argocd_namespace }} -o name 2>/dev/null || echo ""
      args:
        executable: /bin/bash
      register: argocd_applications
      changed_when: false
      failed_when: false

    - name: Display ArgoCD Applications that will be deleted
      ansible.builtin.debug:
        msg:
          - "The following ArgoCD Applications will be deleted:"
          - "{{ argocd_applications.stdout_lines }}"
          - ""
          - "Note: Applications managed by ArgoCD will be removed from the cluster."
      when: argocd_applications.stdout | length > 0

    - name: Delete all ArgoCD Applications
      ansible.builtin.shell:
        cmd: kubectl delete applications --all -n {{ argocd_namespace }} --timeout=60s
      args:
        executable: /bin/bash
      when: argocd_applications.stdout | length > 0
      ignore_errors: true

    - name: Wait for Applications to be deleted
      ansible.builtin.pause:
        seconds: 10
      when: argocd_applications.stdout | length > 0

    - name: Check if ArgoCD Helm release exists
      ansible.builtin.shell:
        cmd: helm list -n {{ argocd_namespace }} -q | grep -q "^argocd$" && echo "exists" || echo "not_exists"
      args:
        executable: /bin/bash
      register: argocd_release_check
      changed_when: false
      failed_when: false

    - name: Uninstall ArgoCD Helm release
      ansible.builtin.shell:
        cmd: helm uninstall argocd -n {{ argocd_namespace }}
      args:
        executable: /bin/bash
      when: argocd_release_check.stdout == "exists"

    - name: Wait for ArgoCD resources to be deleted
      ansible.builtin.pause:
        seconds: 10
      when: argocd_release_check.stdout == "exists"

    - name: Delete ArgoCD namespace (optional)
      ansible.builtin.shell:
        cmd: kubectl delete namespace {{ argocd_namespace }} --timeout=60s
      args:
        executable: /bin/bash
      when: argocd_release_check.stdout == "exists"
      ignore_errors: true

    - name: Display uninstall status
      ansible.builtin.debug:
        msg:
          - "ArgoCD has been uninstalled successfully!"
          - "Helm release 'argocd' has been removed from namespace '{{ argocd_namespace }}'"
          - "All ArgoCD Applications have been deleted"
          - "Note: If the namespace still exists, you can delete it manually with:"
          - "  kubectl delete namespace {{ argocd_namespace }}"

