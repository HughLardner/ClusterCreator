---
- name: Create Sealed Secrets from Ansible Vault
  hosts: localhost
  gather_facts: true
  connection: local
  vars:
    project_root: "{{ playbook_dir }}/.."
    secrets_output_dir: "{{ project_root }}/kubernetes/secrets"
    temp_dir: "/tmp/sealed-secrets-{{ ansible_date_time.epoch }}"
  tasks:
    - name: Load Ansible Vault secrets
      ansible.builtin.include_vars:
        file: argocd/vault/main.yaml
      tags:
        - always
      # Note: This requires --ask-vault-pass or ANSIBLE_VAULT_PASSWORD_FILE

    - name: Validate required secrets are defined
      ansible.builtin.assert:
        that:
          - grafana_admin_password is defined
          - minio_root_user is defined
          - minio_root_password is defined
        fail_msg: "Required secrets not found in vault. Ensure argocd/vault/main.yaml contains: grafana_admin_password, minio_root_user, minio_root_password"
        success_msg: "All required secrets found in vault"
      tags:
        - validate

    - name: Check if kubeseal is installed
      ansible.builtin.command:
        cmd: which kubeseal
      register: kubeseal_check
      changed_when: false
      failed_when: false

    - name: Fail if kubeseal is not installed
      ansible.builtin.fail:
        msg: |
          kubeseal is not installed. Install it with:
          macOS: brew install kubeseal
          Linux: See https://github.com/bitnami-labs/sealed-secrets/releases
      when: kubeseal_check.rc != 0

    - name: Check if Sealed Secrets controller is running
      ansible.builtin.shell:
        cmd: kubectl get deployment sealed-secrets-controller -n kube-system 2>/dev/null && echo "exists" || echo "not_exists"
      args:
        executable: /bin/bash
      register: sealed_secrets_controller_check
      changed_when: false
      failed_when: false

    - name: Warn if Sealed Secrets controller is not running
      ansible.builtin.debug:
        msg:
          - "⚠️  WARNING: Sealed Secrets controller not found in cluster!"
          - "kubeseal requires the controller to be running to fetch the public key."
          - "Install it first: ansible-playbook ansible/sealed-secrets-setup.yaml -e cluster_name=your-cluster"
      when: sealed_secrets_controller_check.stdout == "not_exists"
      tags:
        - always

    - name: Ensure secrets output directory exists
      ansible.builtin.file:
        path: "{{ secrets_output_dir }}"
        state: directory
        mode: '0755'

    - name: Create temporary directory for secret manifests
      ansible.builtin.file:
        path: "{{ temp_dir }}"
        state: directory
        mode: '0700'

    - name: Create Grafana admin secret manifest (dry-run)
      ansible.builtin.shell:
        cmd: >
          kubectl create secret generic grafana-admin-credentials
          --from-literal=admin-password='{{ grafana_admin_password }}'
          --namespace=monitoring
          --dry-run=client -o yaml > {{ temp_dir }}/grafana-secret.yaml
      args:
        executable: /bin/bash
      tags:
        - grafana

    - name: Seal Grafana secret
      ansible.builtin.shell:
        cmd: kubeseal < {{ temp_dir }}/grafana-secret.yaml > {{ secrets_output_dir }}/grafana-sealed-secret.yaml
      args:
        executable: /bin/bash
      tags:
        - grafana

    - name: Create MinIO root credentials secret manifest (dry-run)
      ansible.builtin.shell:
        cmd: >
          kubectl create secret generic minio-root-credentials
          --from-literal=root-user='{{ minio_root_user }}'
          --from-literal=root-password='{{ minio_root_password }}'
          --namespace=minio
          --dry-run=client -o yaml > {{ temp_dir }}/minio-secret.yaml
      args:
        executable: /bin/bash
      tags:
        - minio

    - name: Seal MinIO secret
      ansible.builtin.shell:
        cmd: kubeseal < {{ temp_dir }}/minio-secret.yaml > {{ secrets_output_dir }}/minio-sealed-secret.yaml
      args:
        executable: /bin/bash
      tags:
        - minio

    - name: Display created SealedSecrets
      ansible.builtin.debug:
        msg:
          - "✅ SealedSecrets created successfully!"
          - "Grafana: {{ secrets_output_dir }}/grafana-sealed-secret.yaml"
          - "MinIO: {{ secrets_output_dir }}/minio-sealed-secret.yaml"
          - "These files are encrypted and safe to commit to Git"
      tags:
        - always

    - name: Clean up temporary directory
      ansible.builtin.file:
        path: "{{ temp_dir }}"
        state: absent
      tags:
        - always

