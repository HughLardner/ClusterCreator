---
- name: Install Sealed Secrets Controller
  hosts: controlplane[0]
  gather_facts: false
  tags:
    - sealed_secrets
  vars:
    sealed_secrets_version: "0.24.0"
    sealed_secrets_namespace: "kube-system"
  tasks:
    - name: Check if Sealed Secrets controller already exists
      ansible.builtin.shell:
        cmd: kubectl get deployment sealed-secrets-controller -n {{ sealed_secrets_namespace }} 2>/dev/null && echo "exists" || echo "not_exists"
      args:
        executable: /bin/bash
      register: sealed_secrets_check
      changed_when: false
      failed_when: false

    - name: Install Sealed Secrets controller
      ansible.builtin.shell:
        cmd: >
          kubectl apply -f
          https://github.com/bitnami-labs/sealed-secrets/releases/download/v{{ sealed_secrets_version }}/controller.yaml
      args:
        executable: /bin/bash
      when: sealed_secrets_check.stdout == "not_exists"

    - name: Wait for Sealed Secrets controller to be ready
      ansible.builtin.shell:
        cmd: >
          kubectl rollout status deployment/sealed-secrets-controller
          --namespace {{ sealed_secrets_namespace }}
          --timeout=300s
      args:
        executable: /bin/bash
      when: sealed_secrets_check.stdout == "not_exists"
      tags:
        - sealed_secrets_wait

    - name: Check if Sealed Secrets pods exist
      ansible.builtin.shell:
        cmd: >
          kubectl get pods -n {{ sealed_secrets_namespace }}
          -l app.kubernetes.io/name=sealed-secrets
          --no-headers 2>/dev/null | wc -l
      args:
        executable: /bin/bash
      register: sealed_secrets_pod_count
      changed_when: false
      failed_when: false
      tags:
        - sealed_secrets_info

    - name: Get Sealed Secrets controller pod status
      ansible.builtin.shell:
        cmd: >
          kubectl get pods -n {{ sealed_secrets_namespace }}
          -l app.kubernetes.io/name=sealed-secrets
          -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "not_found"
      args:
        executable: /bin/bash
      register: sealed_secrets_status
      changed_when: false
      failed_when: false
      when: sealed_secrets_pod_count.stdout | int > 0
      tags:
        - sealed_secrets_info

    - name: Set default status when no pods found
      ansible.builtin.set_fact:
        sealed_secrets_status_value: "No pods found"
      when: sealed_secrets_pod_count.stdout | int == 0
      tags:
        - sealed_secrets_info

    - name: Set status from pod check
      ansible.builtin.set_fact:
        sealed_secrets_status_value: "{{ sealed_secrets_status.stdout | default('Unknown') }}"
      when:
        - sealed_secrets_pod_count.stdout | int > 0
        - sealed_secrets_status is not skipped
      tags:
        - sealed_secrets_info

    - name: Display Sealed Secrets status
      ansible.builtin.debug:
        msg:
          - "Sealed Secrets controller status: {{ sealed_secrets_status_value | default('Checking...') }}"
          - "Pod count: {{ sealed_secrets_pod_count.stdout }}"
          - "{% if sealed_secrets_status_value == 'Running' %}Sealed Secrets controller is ready to decrypt SealedSecret resources{% elif sealed_secrets_status_value == 'No pods found' %}No pods found - controller may still be starting{% else %}Controller status: {{ sealed_secrets_status_value }}{% endif %}"
          - "Once ready, create SealedSecrets using: kubeseal < secret.yaml > sealed-secret.yaml"
      tags:
        - sealed_secrets_info
